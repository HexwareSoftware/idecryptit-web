{{> nav navFirmware=true}}

<div class="container-fluid">
    {{{breadcrumbs
        (arr "Firmware Files" "/fw/files")
        (arr "IMG3" "/fw/formats/img3")
        "KBAG"
    }}}

    <div class="row">
        <div class="col-md-2">
            {{{toc
                (arr "#headingTagFormat" "Tag Format")
                (arr "#headingExample" "Example Tag")
            }}}
        </div>

        <div class="col-md-10">
            <h1>IMG3 Tag: <code>KBAG</code></h1>
            <p>
                The <code>KBAG</code> <a href="/fw/formats/img3">IMG3</a> tag is an array of bytes, usually encrypted with the GID Key.
                It consists of a "magic," some info about the size, some info about the IV/key pair, and the IV and key themselves.
            </p>

            <h2 id="headingTagFormat">Tag Format</h2>
            <div class="alert alert-primary" role="alert">
                All file offsets are in hexadecimal, and all values are stored in little endian.
            </div>
            <pre>
Img3KbagTag {
   0  uint32  magic;       // "GABK" ("KBAG" in little endian)
   4  uint32  totalLength; // including header
   8  uint32  dataLength;  // excluding this 0xC header and padding
   C  uint32  cryptState;  // 0x1: IV/key are encrypted with the GID key
                           // 0x2: Used with a second KBAG for the <a href="/processors/s5l8920">S5L8920</a>; use is unknown
  10  uint32  aesType;     //  0x80: AES-128 (16 byte key)
                           //  0xC0: AES-192 (24 byte key)
                           // 0x100: AES-256 (32 byte key)
  14  uint8[16] iv;
  24  uint8[16/24/32] key; // length depends on "aesType"
????  uint8[] pad;
}</pre>

            <h2 id="headingExample">Example Tag</h2>
            <p>
                The following tag is from the <a href="/fw/files/appleLogo">AppleLogo</a> file from the <a href="/fw/keys/5A347/iphone11">2.0 (build 5A347) build for the iPhone 2G (<code>iPhone1,1</code>)</a>.
            </p>
            <pre class="hexView">
        0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F
1C80:                                      <span class="bg-red">47 41 42 4B</span>              GABK
1C90:  44 00 00 00 38 00 00 00 <span class="bg-orange">01 00 00 00</span> <span class="bg-yellow">80 00 00 00</span>  D...8.......€...
1CA0:  <span class="bg-green">CA 5C 08 00 96 7C 23 64 8C 1F 24 FE 6A BD 34 19</span>  Ê\..–|#dŒ.$þj½4.
1CB0:  <span class="bg-blue">35 30 CF F9 80 84 9C 41 7F 49 F0 14 D1 2B F2 73</span>  50Ïù€„œA.Ið.Ñ+òs
1CC0:  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</pre>
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Offset</th>
                        <th scope="col">Length</th>
                        <th scope="col">Explanation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code class="bg-red">0x1C8C</code></td>
                        <td>4</td>
                        <td>
                            <code>magic</code>: When interpreted in little endian order, these bytes give the string, <code>KBAG</code>.
                        </td>
                    </tr>
                    <tr>
                        <td><code>0x1C90</code></td>
                        <td>4</td>
                        <td>
                            <code>totalLength</code>: Indicates that this tag is <code>0x44</code> (68) bytes long.
                        </td>
                    </tr>
                    <tr>
                        <td><code>0x1C94</code></td>
                        <td>4</td>
                        <td>
                            <code>dataLength</code>: Indicates that this tag (without the header) is <code>0x38</code> (56) bytes long.
                        </td>
                    </tr>
                    <tr>
                        <td><code class="bg-orange">0x1C98</code></td>
                        <td>4</td>
                        <td>
                            <code>cryptState</code>: Indicates that this tag's IV/key pair is encrypted with the GID key.
                        </td>
                    </tr>
                    <tr>
                        <td><code class="bg-yellow">0x1C9C</code></td>
                        <td>4</td>
                        <td>
                            <code>aesType</code>: Indicates that the <a href="/fw/formats/img3/data"><code>DATA</code></a> tag is encrypted with AES&#8209;128 and that the key is 16 bytes (128 bits) long.
                        </td>
                    </tr>
                    <tr>
                        <td><code class="bg-green">0x1CA0</code></td>
                        <td>16</td>
                        <td>
                            <code>iv</code>: The encrypted IV.
                        </td>
                    </tr>
                    <tr>
                        <td><code class="bg-blue">0x1CB0</code></td>
                        <td>16</td>
                        <td>
                            <code>key</code>: The encrypted key.
                        </td>
                    </tr>
                    <tr>
                        <td><code>0x1CC0</code></td>
                        <td>16</td>
                        <td>
                            <code>pad</code>: Padding.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{{> footer}}